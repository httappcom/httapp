/*
 * utility class to support common patient logic
*/

public class PatientUtil {

  public static Patient__c queryPatientAll(Id pPatientId) { 
      if(pPatientId == null) {          
        return null;
      } else {           
        return [Select id, 
                       Name,
                       CreatedBy.Name,
                       LastModifiedBy.Name,
                       Owner.Name,
                       Advocate_Email__c,
                       Advocate_Name__c,
                       Advocate_Phone__c,
                       Alternate_Email__c,
                       City__c,
                       Country__c,
                       Date_of_Birth__c,
                       Email__c,
                       Gender__c,
                       Mobile__c,
                       Patient_Stage__c,
                       Phone__c,
                       Postal_Code__c,
                       Preferred_Language__c,
                       Salutation__c,
                       State__c,
                       Street__c,
                       Time_Zone__c,
                       Key_Contact__c,
                       Last_Communication__c,
                       Nationality__c,
                       Age__c,
                       (select id, 
                               Name,
                               CreatedBy.Name,
                               CreatedDate,                                                             
                               LastModifiedBy.Name,
                               Additional_Amount__c,
                               Amount__c,
                               Best_Time_to_Contact__c, 
                               Case_Manager_s_Feel__c,
                               Close_Date__c,
                               Decision_Timeframe__c,
                               Deposit_Required__c,
                               Financial_Reconciliation__c, 
                               Financing_Reguired__c,
                               Hospital_Destination__c,
                               Inquiry_Quality__c,
                               Inquiry_Source__c, 
                               On_Site_Recovery_Period__c,
                               Patient__r.Original_Number_Rank__c,
                               Patient__c,
                               Patient_Email__c,
                               Payment_Type__c, 
                               Phase__c,
                               Post_Op_Follow_Up_Program__c,
                               Preferred_Destination__c,
                               Preferred_Form_of_Contact__c, 
                               Preferred_Travel_Date_From__c,
                               Preferred_Travel_Date_To__c,
                               Primary_Provider__c,
                               Procedure__c, 
                               Procedure_Category__c,
                               Procedure_Date__c,
                               Procedure_Treatment_Type__c,
                               Response_SLA__c, 
                               Stage__c,
                               Sub_Stage__c,
                               Treatment_Date__c,
                               Patient_Not_Committed_Reason__c,
                               Patient__r.Name,
                               Probability__c,
                               Request_Summary__c,
                               Next_Follow_Up__c,
                               Primary_Campaign__c,
                               Related_Campaign__c,
                               Treatment_Summary__c                                 
                       from Treatments__r),
                       (select id,
                               Owner.Name,
                               CallDurationInSeconds,
                               CallObject,
                               CallDisposition,
                               CallType,
                               Description,
                               CreatedBy.Name,
                               ActivityDate,
                               LastModifiedBy.Name,
                               Who.Name,
                               Priority,
                               What.Name,
                               Status,
                               Subject
                       from Tasks order by CreatedDate desc), 
                     /*(select id,
                               Name,
                              CreatedBy.Name,
                              LastModifiedBy.Name,
                              Owner.Name,
                              Body_Rich_Text__c,
                              Body__c,
                              Truncated_Body__c,
                              From_Name__c,
                              From__c,
                              Has_Attachments__c,
                              Priority__c,
                              IsRead__c,
                              Reply_Rich_Text__c,
                              Reply__c,
                              Sent__c,
                              Status__c,
                              To_Name__c,
                              To__c
                      from Messages__r), */ //todo fix the message relationship                                                                    
                      (select Id,
                              Name,
                              CreatedBy.Name,
                              LastModifiedBy.Name,
                              Airfare_Coordination_Needed__c,
                              Booking_Status__c,
                              //Companion__c,
                              Date_Of_Birth__c,
                              Extra_Local_Concier__c,
                              Ground_Transportation_Needed__c,
                              Hotel_Coordination_Needed__c,
                              Itinerary_Summary__c,
                              Number_of_Hospital_Nights__c,
                              Passport_Status__c,
                              Pre_Op__c,
                              Pre_Op_Instructions__c,
                              Procedure_Date__c,
                              Special_Passport_Visa__c,
                              Travel_Alert__c,
                              Travel_End__c,
                              Travel_Start__c,
                              Visa_Status__c,
                              Wheel_Chair_Bound__c,
                              Additions_Comments__c,
                              Close_Date__c,
                              Companion__c,
                              Event_Diagnosis__c,
                              Flying__c,
                              Hotel_Nights_Included__c,
                              Hotel_Nights_Needed__c,
                              Insurance_Approval__c,
                              Special_Hotel_Needs__c,
                              Total_Added_Cost__c,
                              Treatment_as_Quoted__c ,
                              Arrival_Airline__c,
                              Arrival_Airport_Code__c,
                              Arrival_Flight_No__c,
                              Departure_Airline__c,
                              Departure_Airport_Code__c,
                              Departure_Flight_No__c,                              
                              Notes__c                                
                      from Travels__r),
                      (select Id,
                              Name,
                              Benefit_Percentage__c,
                              Claim_Address__c,
                              Co_pay__c,
                              CreatedBy.Name,
                              CreatedDate, 
                              Deductible__c,
                              IsDeleted,
                              Dependent_Coverage__c,
                              Effective_Date__c, 
                              Fax_Number_Medical_Reviews__c,
                              Group__c,
                              Insurance_Contact__c,
                              LastModifiedBy.Name, 
                              LastModifiedDate,
                              Name_of_Insurance__c,
                              Patient__c,
                              Payment_Type__c,
                              Policy_ID__c, 
                              SystemModstamp,
                              Treatment__c,
                              Verification_Date__c,
                              Verification_Phone_Number__c 
                      from Payments__r),
                      (select Id,
                              Name,
                              CreatedBy.Name,
                              CreatedDate,
                              IsDeleted,
                              LastModifiedBy.Name, 
                              LastModifiedDate,
                              Patient__c,
                              SystemModstamp,
                              Treatment__c         
                      from Medical_Profiles__r),
                      (Select Id, 
                              Name,                       
                              CreatedDate, 
                              CreatedBy.Name,
                              LastModifiedBy.Name, 
                              LastModifiedDate,
                              Patient__c, 
                              Treatment__c ,
                              Patient__r.Name, 
                              Treatment__r.Name,
                              Contact__r.Name,
                              Account__r.Name,
                              Contact_Email__c,
                              Contact_Phone__c,
                              Date_Time_Closed__c,
                              Date_Time_Opened__c,                              
                              Status__c,
                              Category__c,
                              Sub_Category__c,
                              Subject__c,
                              Type__c,
                              Due_Date__c , 
                              Contact__c,
                               Account__c                                                      
                       From Incidents__r),
                      (SELECT Id,
                              Name,
                              City__c,
                              Country__c, 
                              CreatedById, 
                              CreatedDate, 
                              IsDeleted, 
                              Description__c, 
                              Discount_Amount__c, 
                              Doctor_Name__c, 
                              Email__c,
                              Expiration_Date__c, 
                              Facility_Location__c,
                              Facility_Name__c,
                              Fax__c, 
                              Grand_Total__c, 
                              LastModifiedById, 
                              LastModifiedDate, 
                              Name__c, 
                              Patient__c, 
                              Patient_Name__c, 
                              Phone__c, 
                              Postal__c, 
                              Procedure_Date__c, 
                              Province__c,  
                              Status__c, 
                              Street__c, 
                              Sub_Total__c, 
                              SystemModstamp, 
                              Total_Price__c, 
                              Treatment__c ,
                              Ground_Transportation_Included__c,
                              Hotel_Nights_Included__c,
                              Hotel_Nights_Needed__c,
                              Number_of_Hospital_Nights__c,
                              Arrival_Date__c,
                              Departure_Date__c,
                              Tax__c,
                              Syncing__c
                        From Treatment_Quotes__r)
                from Patient__c 
                where id = :pPatientId];               
      }  
   }
  public static List<Patient__c> queryPatientListAll() {    
      
        return [Select id, 
                       Name,
                       CreatedBy.Name,
                       LastModifiedBy.Name,
                       Owner.Name,
                       Advocate_Email__c,
                       Advocate_Name__c,
                       Advocate_Phone__c,
                       Alternate_Email__c,
                       City__c,
                       Country__c,
                       Date_of_Birth__c,
                       Email__c,
                       Gender__c,
                       Mobile__c,
                       Patient_Stage__c,
                       Phone__c,
                       Postal_Code__c,
                       Preferred_Language__c,
                       Salutation__c,
                       State__c,
                       Street__c,
                       Time_Zone__c,
                       Key_Contact__c,
                       Last_Communication__c,
                       Nationality__c,
                       (select id, 
                               Name,
                               CreatedBy.Name,
                               CreatedDate,                               
                               LastModifiedBy.Name,
                               Additional_Amount__c,
                               Amount__c,
                               Best_Time_to_Contact__c, 
                               Case_Manager_s_Feel__c,
                               Close_Date__c,
                               Decision_Timeframe__c,
                               Deposit_Required__c,
                               Financial_Reconciliation__c, 
                               Financing_Reguired__c,
                               Hospital_Destination__c,
                               Inquiry_Quality__c,
                               Inquiry_Source__c, 
                               On_Site_Recovery_Period__c,
                               Patient__r.Original_Number_Rank__c,
                               Patient__c,
                               Patient_Email__c,
                               Payment_Type__c, 
                               Phase__c,
                               Post_Op_Follow_Up_Program__c,
                               Preferred_Destination__c,
                               Preferred_Form_of_Contact__c, 
                               Preferred_Travel_Date_From__c,
                               Preferred_Travel_Date_To__c,
                               Primary_Provider__c,
                               Procedure__c, 
                               Procedure_Category__c,
                               Procedure_Date__c,
                               Procedure_Treatment_Type__c,
                               Response_SLA__c, 
                               Stage__c,
                               Sub_Stage__c,
                               Treatment_Date__c,
                               Patient_Not_Committed_Reason__c,
                               Patient__r.Name,
                               Probability__c,
                               Request_Summary__c,                               
                               Next_Follow_Up__c,
                               Primary_Campaign__c,
                               Related_Campaign__c,
                               Treatment_Summary__c 
                       from Treatments__r),
                       (select id,
                               Owner.Name,
                               CallDurationInSeconds,
                               CallObject,
                               CallDisposition,
                               CallType,
                               Description,
                               CreatedBy.Name,
                               ActivityDate,
                               LastModifiedBy.Name,
                               Who.Name,
                               Priority,
                               What.Name,
                               Status,
                               Subject
                       from Tasks order by CreatedDate desc), 
                     /*(select id,
                               Name,
                              CreatedBy.Name,
                              LastModifiedBy.Name,
                              Owner.Name,
                              Body_Rich_Text__c,
                              Body__c,
                              Truncated_Body__c,
                              From_Name__c,
                              From__c,
                              Has_Attachments__c,
                              Priority__c,
                              IsRead__c,
                              Reply_Rich_Text__c,
                              Reply__c,
                              Sent__c,
                              Status__c,
                              To_Name__c,
                              To__c
                      from Messages__r), */ //todo fix the message relationship                                                                    
                      (select Id,
                              Name,
                              CreatedBy.Name,
                              LastModifiedBy.Name,
                              Airfare_Coordination_Needed__c,
                              Booking_Status__c,
                              //Companion__c,
                              Date_Of_Birth__c,
                              Extra_Local_Concier__c,
                              Ground_Transportation_Needed__c,
                              Hotel_Coordination_Needed__c,
                              Itinerary_Summary__c,
                              Number_of_Hospital_Nights__c,
                              Passport_Status__c,
                              Pre_Op__c,
                              Pre_Op_Instructions__c,
                              Procedure_Date__c,
                              Special_Passport_Visa__c,
                              Travel_Alert__c,
                              Travel_End__c,
                              Travel_Start__c,
                              Visa_Status__c,
                              Wheel_Chair_Bound__c                                                        
                      from Travels__r),
                      (select Id,
                              Name,
                              Benefit_Percentage__c,
                              Claim_Address__c,
                              Co_pay__c,
                              CreatedBy.Name,
                              CreatedDate, 
                              Deductible__c,
                              IsDeleted,
                              Dependent_Coverage__c,
                              Effective_Date__c, 
                              Fax_Number_Medical_Reviews__c,
                              Group__c,
                              Insurance_Contact__c,
                              LastModifiedBy.Name, 
                              LastModifiedDate,
                              Name_of_Insurance__c,
                              Patient__c,
                              Payment_Type__c,
                              Policy_ID__c, 
                              SystemModstamp,
                              Treatment__c,
                              Verification_Date__c,
                              Verification_Phone_Number__c ,
                              Treatment__r.Name , 
                              Patient__r.Name                                                           
                      from Payments__r),
                      (select Id,
                              Name,
                              CreatedBy.Name,
                              CreatedDate,
                              IsDeleted,
                              LastModifiedBy.Name, 
                              LastModifiedDate,
                              Patient__c,
                              SystemModstamp,
                              Treatment__c         
                      from Medical_Profiles__r),
                      (Select Id, 
                              Name,                       
                              CreatedDate, 
                              CreatedBy.Name,
                              LastModifiedBy.Name, 
                              LastModifiedDate,
                              Patient__c, 
                              Treatment__c,                              
                              Patient__r.Name,
                              Treatment__r.Name,
                              Contact__r.Name,
                              Account__r.Name,
                              Contact_Email__c,
                              Contact_Phone__c,
                              Date_Time_Closed__c,
                              Date_Time_Opened__c,                              
                              Status__c,
                              Category__c,
                              Sub_Category__c,
                              Subject__c,
                              Type__c,
                              Due_Date__c                                                            
                       From Incidents__r),
                      (SELECT Id,
                              Name,
                              City__c,
                              Country__c, 
                              CreatedById, 
                              CreatedDate, 
                              IsDeleted, 
                              Description__c, 
                              Discount_Amount__c, 
                              Doctor_Name__c, 
                              Email__c,
                              Expiration_Date__c, 
                              Facility_Location__c,
                              Facility_Name__c,
                              Fax__c, 
                              Grand_Total__c, 
                              LastModifiedById, 
                              LastModifiedDate, 
                              Name__c, 
                              Patient__c, 
                              Patient_Name__c, 
                              Phone__c, 
                              Postal__c, 
                              Procedure_Date__c, 
                              Province__c,  
                              Status__c, 
                              Street__c, 
                              Sub_Total__c, 
                              SystemModstamp, 
                              Total_Price__c, 
                              Treatment__c 
                        From Treatment_Quotes__r)
                from Patient__c];
                             
    }
    
    /**
     * mWicherski@mkpartners.com
     * createPatientPortalUser
     * Creates an account and contact for the patient and calls a future method
     * to create the portal user.
     * @param string patientID
     */
    public static void createPatientPortalUser (string patientID) {
    	
    	// query patient for data
    	Patient__c patient = [select 	id,
    									Name, 
    									Patient_First_Name__c, 
    									Patient_Last_Name__c, 
    									email__c, 
    									Date_of_Birth__c,
    									key_contact__c 
    								from Patient__c 
    								where id = :patientID];
    	
    	Account a = new Account();
    	a.name = patient.Name;
    	insert a;
    	
    	Contact c = new Contact();
    	c.firstname = patient.patient_first_name__c;
    	c.lastname = patient.patient_last_name__c;
    	c.email = patient.email__c;
    	c.birthdate = patient.date_of_birth__c;
    	c.accountid = a.id;
    	
    	insert c;
    	
    	patient.Key_Contact__c = c.id;
    	update patient;
    	
    	futureCreatePortalUser(patient.id);
    }
    
    /**
     * mWicherski@mkpartners.com
     * futureCreatePortalUser
     * facilitates actual portal user creation.
     * @param string patientID
     */   
    @future
    public static void futureCreatePortalUser(string patientid) { 
		
		// query patient for data
    	Patient__c patient = [select 	id, 
    									Patient_First_Name__c, 
    									Patient_Last_Name__c, 
    									email__c, 
    									Date_of_Birth__c,
    									key_contact__c,
    									key_contact__r.accountid 
    								from Patient__c 
    								where id = :patientID];
		
		
		User u = new User();
    	string username = patient.Patient_First_Name__c.substring(0,1);
    	username+=patient.patient_last_name__c;
    	username+=string.valueof(patient.Date_of_Birth__c.year()).substring(2,3); 
    	username.replace(' ','_');
    	
        u.Username = username+='@patient.htt.com';
        u.Email = patient.email__c;
        u.CommunityNickname = username;
    		
    	// create portal user
    	String userId;
   		userId = Site.createPortalUser(	u, 
   										patient.key_contact__r.accountid,
   										null);    											
    }
}