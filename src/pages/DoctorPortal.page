<apex:page controller="ProviderPortalController" showheader="false" sidebar="false" standardstylesheets="true"
    title="{!prmConfig.Facilitator_Name__c}" action="{!load}">
    <apex:includeScript value="{!URLFOR($Resource.KenResources, '/js/jquery-1.8.2.min.js')}"/>
    <apex:includeScript value="{!URLFOR($Resource.KenResources, '/js/jquery-ui-1.8.20.custom.min.js')}"/>
    <apex:stylesheet value="{!$Resource.SurveyResponse}"/>
    <script>
        var j$ = jQuery.noConflict();
    </script>
    <apex:stylesheet value="{!$Resource[prmConfig.Patient_Portal_CSS__c]}"/>
	<c:PortalBackground />

<!--[if gte IE 9]>
  <style type="text/css">
    .gradient {
       filter: none;
    }
  </style>
<![endif]-->
    <style>
        .surveyResultsLBox{
                background-color: white;
                border-style: solid;
                border-width: 2px;
                border-color: #000;
                left: 50%;
                padding:10px;
                position: absolute;
                z-index: 9999;
                width: 900px;
                margin-left: -250px;
                top:130px;
                //top:50px;
            }
             
            .surveyResultsBox{
                /*display: none;*/ 
                position: absolute;
                top: 0;/* must be 0 ideally*/
                left: 0;/* must be 0 ideally */
                width: 100%;
                height: 100%;
                background-color: #000;
                z-index:1001;
                -moz-opacity: 0.5;
                opacity:.50;
                filter: alpha(opacity=50);
                /*zoom: 1;*/
            }
            
    </style>
    
    <body>
    <div id="body-wrapper">
<header>
<div id="header">
<img alt="" src="/servlet/servlet.FileDownload?file={!IF(ISBLANK(destinationFacility), prmConfig.Provider_Portal_Banner_Image__c, destinationFacility.Provider_Portal_Banner_Image__c)}" border="0"/>
</div>
</header>
<div class="clear"></div>
    
    <apex:form >
    	<apex:actionFunction name="showSurveyResults" action="{!showSurveyResults}" reRender="surveyResultsPanel"> 
        	<apex:param name="surveyId" assignTo="{!surveyId}" value="" /> 
    	</apex:actionFunction> 
    	<apex:actionFunction name="approveTreatment" action="{!approveTreatment}" reRender="pbsPatientDashboard"> 
        	<apex:param name="treatmentId" assignTo="{!treatmentId}" value="" /> 
    	</apex:actionFunction>
    	<apex:actionFunction name="denyTreatment" action="{!denyTreatment}" reRender="pbsPatientDashboard"> 
        	<apex:param name="treatmentId" assignTo="{!treatmentId}" value="" /> 
    	</apex:actionFunction> 
<div class="clear"></div>
<div id="content-wrapper">
    <div id="content">
    
            <apex:pageblock >
                <apex:outputpanel rendered="{!currentpage == 'Portal User Error'}">
                    Your user has not been set up properly for the provider portal.<br/><br/>
                    Please contact support for assistance. 
                </apex:outputpanel>
                
                <apex:outputpanel rendered="{!currentpage == 'Home'}">
                    {!patient.Patient_First_Name__c},<br/><br/>
                    <apex:outputField value="{!prmConfig.Doctor_Portal_Welcome_Msg__c}" rendered="{!destinationFacility==null}"/>
                    <apex:outputField value="{!destinationFacility.Doctor_Portal_Welcome_Msg__c}" rendered="{!destinationFacility!=null}"/>
                    <br/><br/>
                </apex:outputpanel>

				<apex:pageBlockSection id="pbsCollaboration" collapsible="true" title="Collaboration" rendered="{!!ISNULL(commPatientId) && !ISNULL(commTreatmentId)}">
				  <apex:panelGrid columns="1">
				  <apex:actionRegion >
				      	<apex:actionFunction name="commPatientChanged" action="{!commPatientChanged}" reRender="pbsCollaboration"/>
				      	<apex:actionFunction name="commTreatmentChanged" action="{!commTreatmentChanged}" reRender="pbsCollaboration"/>
				  
						<apex:outputPanel id="commPanel1" layout="block">
						  <apex:outputPanel rendered="{!!ISNULL(patientSelectList) && patientSelectList.size>0}">
							<apex:outputLabel value="Patient"/>&nbsp;
							<apex:selectList value="{!commPatientId}" multiselect="false" onchange="commPatientChanged();" size="1">
            					<apex:selectOptions value="{!patientSelectList}"/>
        					</apex:selectList>&nbsp;&nbsp;&nbsp;
        				  </apex:outputPanel>
						  <apex:outputPanel rendered="{!!ISNULL(treatmentSelectList) && treatmentSelectList.size>0}">
							<apex:outputLabel value="Treatment"/>&nbsp;
							<apex:selectList value="{!commTreatmentId}" multiselect="false" onchange="commTreatmentChanged();" size="1">
            					<apex:selectOptions value="{!treatmentSelectList}"/>
        					</apex:selectList>
						  </apex:outputPanel>
						</apex:outputPanel>
					</apex:actionRegion>
					<div>
					<c:messaging pId="{!commPatientId}" treatmentId="{!commTreatmentId}" canAddCareTeamMember="false" />
					</div>
					</apex:panelGrid>
				</apex:pageBlockSection>
				                
				<apex:pageBlockSection id="pbsPatientDashboard" collapsible="true" title="Patient Dashboard">
					<apex:commandButton action="{!load}" value="Refresh" style="color:black;"/><br/>
                    <apex:pageblocktable value="{!treatmentList}" var="t">
                        <apex:column >
                            <apex:facet name="header">Patient</apex:facet>
	                        <apex:outputPanel styleClass="patientPanel" layout="block">
		                        <a href="javascript:{}"><apex:outputfield value="{!t.treatment.Patient__r.Name}"/></a> 
       			                <div class="patientDetail" id="details{!t.treatment.id}" style="display:none; text-align:center; width:760px">
       			                	<apex:pageBlock >
								        <apex:pageBlockSection showHeader="true" title="" columns="1" collapsible="false">
								            <apex:pageBlockSectionItem >
               									<apex:outputLabel value="" />
               									<apex:outputText value=""/>
							    	        </apex:pageBlockSectionItem>
       		                			</apex:pageBlockSection>
	       		                	</apex:pageBlock>
			                        <a class='close' href='javascript:{}'>close</a>
        	   		            </div>
            	       	    </apex:outputPanel>
                        </apex:column>
                        <apex:column >
                            <apex:facet name="header">Treatment</apex:facet>
                            <apex:outputText value="{!t.treatment.Name & ' (' & t.treatment.Procedure__c & ')'}"/>
                        </apex:column>
                        <apex:column >
                            <apex:facet name="header">Medical Profile</apex:facet>
                            <apex:outputPanel rendered="{!!ISNULL(t.patient.Survey_Headers__r) && t.patient.Survey_Headers__r.size>0}">
                            	<a href="javascript:showSurveyResults('{!t.patient.Survey_Headers__r[0].id}')">View</a>
                            </apex:outputPanel>
                        </apex:column>
                        <!-- apex:column >
                            <apex:facet name="header">Medical Records</apex:facet>
                        </apex:column>
                        <apex:column >
                            <apex:facet name="header">Upload Medical Record</apex:facet>
                        </apex:column> -->
                        <apex:column >
                            <apex:facet name="header">Approval</apex:facet>
                            <apex:outputPanel >
                            	<apex:outputPanel rendered="{!t.treatment.Approval_State__c!='Awaiting Approval'}"><apex:outputText value="{!t.treatment.Approval_State__c}"/></apex:outputPanel>
                            	<apex:outputPanel rendered="{!t.treatment.Approval_State__c=='Awaiting Approval'}">
                            	<a href="javascript:approveTreatment('{!t.treatment.id}');">Approve</a>&nbsp;/&nbsp;
                            	<a href="javascript:denyTreatment('{!t.treatment.id}');">Deny</a>
                            	</apex:outputPanel>
                            </apex:outputPanel>
                        </apex:column>
                        <apex:column >
                            <apex:facet name="header">Stage</apex:facet>
                            <apex:outputText value="{!IF(ISBLANK(t.treatment.Sub_Stage__c),t.treatment.Stage__c,t.treatment.Sub_Stage__c)}"/>
                        </apex:column>
                    </apex:pageblocktable>
				</apex:pageBlockSection>

				<apex:pageBlockSection id="pbsTreatmentCalendar" collapsible="true" title="Treatment Calendar">
				</apex:pageBlockSection>
                
            </apex:pageblock>
          </div>
        </div>
        </apex:form>
    </div>
        <apex:outputPanel layout="block" id="surveyResultsPanel" >
            <apex:outputPanel layout="block" styleClass="surveyResultsBox" rendered="{!displaySurveyResults}" />
            <apex:outputpanel styleClass="surveyResultsLBox" layout="block" rendered="{!displaySurveyResults}" >
                <div align="center">
                    <apex:outputtext style="font-weight:bold;" value="Medical Profile Results"/><br/><br/>
                </div>
				<c:SurveyResponse surveyId="{!surveyId}"/>
                <div align="center">
                    <apex:form >
                        <apex:commandLink value="Close" action="{!hideSurveyResults}" reRender="surveyResultsPanel"  />
                    </apex:form>
                </div>
            </apex:outputpanel>
        </apex:outputpanel>
    </body>
</apex:page>